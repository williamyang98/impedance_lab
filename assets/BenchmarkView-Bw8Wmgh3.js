var j=Object.defineProperty;var K=(x,t,r)=>t in x?j(x,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):x[t]=r;var g=(x,t,r)=>K(x,typeof t!="symbol"?t+"":t,r);import{d as V,j as y,b as c,o as d,f as e,u as w,w as P,p as U,F as D,r as R,t as S,m as A,a as I,k as F,g as q,A as X,l as C}from"./index-CWcrCmoJ.js";import{S as Z,p as G,w as E,_ as H}from"./providers-CZp_rVZ5.js";import{f as O}from"./fuzzysort-EuvyY0K8.js";import{S as N}from"./search-DWQH5LPH.js";class J{constructor(t){g(this,"device");g(this,"compute_pipelines",new Map);g(this,"bind_group_layout");g(this,"pipeline_layout");g(this,"workgroup_size",256);g(this,"inner_loop_count",512);g(this,"iops_per_loop",4);g(this,"simd_width",4);g(this,"params",new Z({loop_count:"s32",init_value:"f32"}));g(this,"params_uniform");this.device=t,this.params_uniform=t.createBuffer({size:this.params.buffer.byteLength,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),this.bind_group_layout=t.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.COMPUTE,buffer:{type:"uniform"}},{binding:1,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}}]}),this.pipeline_layout=t.createPipelineLayout({bindGroupLayouts:[this.bind_group_layout]})}get_type_size_bytes(t){switch(t){case"f16":return 2;case"f32":return 4;case"u32":return 4;case"i32":return 4}}get_inner_loop_code(t){switch(t){case"f16":case"f32":return`
          x = fma(y,x,y);
          y = fma(x,y,x);
        `;case"u32":case"i32":return`
          x = y*x + y;
          y = x*y + x;
        `}}get_benchmark_pipeline(t){let r=this.compute_pipelines.get(t);if(r===void 0){const l=`
        ${t==="f16"?"enable f16;":""}

        struct Params {
          loop_count: i32,
          init_value: f32,
        }

        @group(0) @binding(0) var<uniform> params: Params;
        @group(0) @binding(1) var<storage,read_write> A: array<vec4<${t}>>;

        override workgroup_size = 256;
        override inner_loop_count = 512;

        @compute
        @workgroup_size(workgroup_size,1,1)
        fn main(@builtin(global_invocation_id) _gid: vec3<u32>, @builtin(local_invocation_id) _lid: vec3<u32>) {
          let lid = _lid.x;

          var v = ${t}(params.init_value);
          var x = vec4<${t}>(v, v+1, v+2, v+3);
          var y = vec4<${t}>(${t}(lid));
          for (var iter = 0; iter < params.loop_count; iter++) {
            for (var inner = 0; inner < inner_loop_count; inner++) {
              ${this.get_inner_loop_code(t)}
            }
          }
          let gid = _gid.x;
          A[gid] = y;
        }
      `,_=this.device.createShaderModule({code:l}),i=this.device.createComputePipeline({layout:this.pipeline_layout,compute:{module:_,entryPoint:"main",constants:{workgroup_size:this.workgroup_size,inner_loop_count:this.inner_loop_count}}});r={shader_source:l,shader_module:_,compute_pipeline:i},this.compute_pipelines.set(t,r)}return r}get_init_value(t){switch(t){case"f16":return 1.3;case"f32":return 1.3;case"u32":return 4;case"i32":return-2}}create_pass(t,r,l,_,i){const u=Math.ceil(l/this.workgroup_size/this.simd_width);this.params.set("loop_count",i),this.params.set("init_value",this.get_init_value(_)),this.device.queue.writeBuffer(this.params_uniform,0,this.params.buffer,0,this.params.buffer.byteLength);const m=this.device.createBindGroup({layout:this.bind_group_layout,entries:[{binding:0,resource:{buffer:this.params_uniform,offset:0,size:this.params_uniform.size}},{binding:1,resource:{buffer:r,offset:0,size:r.size}}]}),h=this.get_benchmark_pipeline(_);t.setPipeline(h.compute_pipeline),t.setBindGroup(0,m),t.dispatchWorkgroups(u,1,1)}}class Y{constructor(t,r){g(this,"device");g(this,"query_set");g(this,"query_buffer");g(this,"query_buffer_readback");g(this,"length");this.length=r,this.device=t,this.query_set=this.device.createQuerySet({type:"timestamp",count:2*r}),this.query_buffer=this.device.createBuffer({label:"query_resolve_buffer",size:8*this.query_set.count,usage:GPUBufferUsage.QUERY_RESOLVE|GPUBufferUsage.COPY_SRC}),this.query_buffer_readback=this.device.createBuffer({label:"query_resolve_buffer_map",size:this.query_buffer.size,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ})}get_timestamp_writes(t){if(t<0||t>=this.length)throw Error(`Timestamp index ${t} is out of bounds of length ${this.length}`);return{querySet:this.query_set,beginningOfPassWriteIndex:2*t,endOfPassWriteIndex:2*t+1}}enqueue_read(t){t.resolveQuerySet(this.query_set,0,2*this.length,this.query_buffer,0),t.copyBufferToBuffer(this.query_buffer,this.query_buffer_readback,this.query_buffer.size)}async read_timestamps(){const t=this.query_buffer_readback;await t.mapAsync(GPUMapMode.READ,0,t.size);const r=new BigUint64Array(t.getMappedRange(0,t.size).slice(0));t.unmap();const l=[];for(let _=0;_<this.length;_++){const i=r[2*_],u=r[2*_+1],m=u-i;l.push({start_ns:i,end_ns:u,elapsed_ns:m})}return l}destroy(){this.query_set.destroy(),this.query_buffer.destroy(),this.query_buffer_readback.destroy()}}const ee={class:"card card-border bg-base-100"},te={class:"card-body p-3"},se={class:"w-full"},re={key:0,class:"flex flex-col gap-x-1"},oe={class:"table table-compact w-full"},ae={class:"font-medium"},ie={key:0,class:"font-medium"},ne={key:1,class:"font-medium text-error"},ue=["value"],le={colspan:"2"},pe=["disabled"],de={key:1,class:"w-full text-center py-2"},ce=V({__name:"ComputeBenchmarkView",setup(x){const t=G.gpu_device.value,r=t.features,l=new J(t);function _(){const f=[];return f.push({type:"f16",base_outer_loops:4,iop_unit:"Flop/s",is_supported:r.has("shader-f16")},{type:"f32",base_outer_loops:2,iop_unit:"Flop/s",is_supported:!0},{type:"u32",base_outer_loops:1,iop_unit:"Iop/s",is_supported:!0},{type:"i32",base_outer_loops:1,iop_unit:"Iop/s",is_supported:!0}),f}const i=y(_()),u=y(12),m=y(4),h=y(8),s=y(2),o=y(!1);async function p(f,a,n,b){const k=l.get_type_size_bytes(f.type),W=t.createBuffer({size:n*k,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST|GPUBufferUsage.COPY_SRC}),B=new Y(t,1);try{const z=[];for(let M=0;M<a;M++){const T=t.createCommandEncoder(),$=T.beginComputePass({timestampWrites:B.get_timestamp_writes(0)});l.create_pass($,W,n,f.type,b),$.end(),B.enqueue_read(T),t.queue.submit([T.finish()]),await t.queue.onSubmittedWorkDone();const Q=(await B.read_timestamps())[0].elapsed_ns;z.push(Q),f.curr_step=M+1}return z}catch(z){throw z}finally{W.destroy(),B.destroy()}}async function v(){if(o.value)return;const a=u.value*2048*l.workgroup_size,n=m.value+h.value;o.value=!0;for(const b of i.value)b.curr_step=0,b.total_steps=n,b.iop_rate=void 0,b.error=void 0;for(const b of i.value)if(b.is_supported)try{const k=b.base_outer_loops*s.value,B=(await p(b,n,a,k)).slice(m.value).map($=>Number($)*1e-9),z=B.reduce(($,L)=>$+L,0)/B.length,T=k*l.iops_per_loop*l.inner_loop_count*a/z;b.iop_rate=T}catch(k){b.error=String(k)}o.value=!1}return(f,a)=>(d(),c("div",ee,[e("div",te,[a[10]||(a[10]=e("div",{class:"card-title"},"Compute Throughput",-1)),e("div",se,[w(r).has("timestamp-query")?(d(),c("div",re,[e("table",oe,[e("tbody",null,[e("tr",null,[a[5]||(a[5]=e("td",{class:"font-medium"},"Compute Units",-1)),e("td",null,[P(e("input",{class:"input",type:"number","onUpdate:modelValue":a[0]||(a[0]=n=>u.value=n),min:"1",step:"1"},null,512),[[U,u.value,void 0,{number:!0}]])])]),e("tr",null,[a[6]||(a[6]=e("td",{class:"font-medium"},"Work Multiplier",-1)),e("td",null,[P(e("input",{class:"input",type:"number","onUpdate:modelValue":a[1]||(a[1]=n=>s.value=n),min:"1",step:"1"},null,512),[[U,s.value,void 0,{number:!0}]])])]),e("tr",null,[a[7]||(a[7]=e("td",{class:"font-medium"},"Warmup Steps",-1)),e("td",null,[P(e("input",{class:"input",type:"number","onUpdate:modelValue":a[2]||(a[2]=n=>m.value=n),min:"1",step:"1"},null,512),[[U,m.value,void 0,{number:!0}]])])]),e("tr",null,[a[8]||(a[8]=e("td",{class:"font-medium"},"Warm Steps",-1)),e("td",null,[P(e("input",{class:"input",type:"number","onUpdate:modelValue":a[3]||(a[3]=n=>h.value=n),min:"1",step:"1"},null,512),[[U,h.value,void 0,{number:!0}]])])]),(d(!0),c(D,null,R(i.value,n=>(d(),c("tr",{key:n.type},[e("td",ae,S(n.type),1),e("td",null,[n.is_supported?n.error?(d(),c("span",ne,S(n.error),1)):n.iop_rate===void 0?(d(),c("progress",{key:2,class:"w-full h-[1rem] progress progress-info",value:(n.curr_step??0)/(n.total_steps??1)*100,max:"100"},null,8,ue)):(d(),c(D,{key:3},[A(S(w(E)(n.iop_rate,n.iop_unit,3)),1)],64)):(d(),c("span",ie,"Not supported"))])]))),128)),e("tr",null,[e("td",le,[e("button",{type:"submit",class:"btn w-full",onClick:a[4]||(a[4]=n=>v()),disabled:o.value},"Run benchmark",8,pe)])])])])])):(d(),c("div",de,a[9]||(a[9]=[e("h1",{class:"text-2xl"},"GPU profiling not supported",-1)])))])])]))}}),_e={class:"card card-border bg-base-100"},me={class:"card-body p-3"},fe={key:0,class:"flex flex-col gap-x-1"},ge={class:"table table-compact"},be={key:0,class:"font-medium text-error"},he=["value"],ve={colspan:"2"},ye=["disabled"],xe={key:1,class:"w-full text-center py-2"},we=V({__name:"MemoryBandwidthBenchmarkView",setup(x){const t=G.gpu_device.value,r=t.features,l=y(!1),_=y(30),i=t.limits.maxStorageBufferBindingSize,u=y({});async function m(){const h=t.createBuffer({size:i,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC}),s=t.createBuffer({size:i,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ}),o=new Y(t,2);l.value=!0;const p=_.value;u.value.curr_step=0,u.value.total_steps=p,u.value.bandwidth=void 0,u.value.error=void 0;try{const v=t.createCommandEncoder();v.beginComputePass({timestampWrites:o.get_timestamp_writes(0)}).end();for(let k=0;k<p;k++)v.copyBufferToBuffer(h,s,i),await s.mapAsync(GPUMapMode.READ,0,i),u.value.curr_step=k+1,s.unmap();v.beginComputePass({timestampWrites:o.get_timestamp_writes(1)}).end(),o.enqueue_read(v),t.queue.submit([v.finish()]),await t.queue.onSubmittedWorkDone();const f=await o.read_timestamps(),a=f[1].start_ns-f[0].end_ns,n=Number(a)*1e-9,b=i*p/n;u.value.bandwidth=b}catch(v){u.value.error=String(v)}finally{l.value=!1,h.destroy(),s.destroy(),o.destroy()}}return(h,s)=>(d(),c("div",_e,[e("div",me,[s[6]||(s[6]=e("div",{class:"card-title"},"Memory Bandwidth",-1)),w(r).has("timestamp-query")?(d(),c("div",fe,[e("table",ge,[e("tbody",null,[e("tr",null,[s[2]||(s[2]=e("td",{class:"font-medium"},"Total Transfers",-1)),e("td",null,[P(e("input",{class:"input",type:"number","onUpdate:modelValue":s[0]||(s[0]=o=>_.value=o),min:"1",step:"1"},null,512),[[U,_.value,void 0,{number:!0}]])])]),e("tr",null,[s[3]||(s[3]=e("td",{class:"font-medium"},"Buffer size",-1)),e("td",null,S(w(E)(w(i),"B",3)),1)]),e("tr",null,[s[4]||(s[4]=e("td",{class:"font-medium"},"Memory bandwidth",-1)),e("td",null,[u.value.error?(d(),c("span",be,S(u.value.error),1)):u.value.bandwidth===void 0?(d(),c("progress",{key:1,class:"w-full h-[1rem] progress progress-info",value:(u.value.curr_step??0)/(u.value.total_steps??1)*100,max:"100"},null,8,he)):(d(),c(D,{key:2},[A(S(w(E)(u.value.bandwidth,"B/s",3)),1)],64))])]),e("tr",null,[e("td",ve,[e("button",{type:"submit",class:"btn w-full",onClick:s[1]||(s[1]=o=>m()),disabled:l.value},"Run benchmark",8,ye)])])])])])):(d(),c("div",xe,s[5]||(s[5]=[e("h1",{class:"text-2xl"},"GPU profiling not supported",-1)])))])]))}}),ke={class:"flex flex-col w-full h-full bg-base-100 gap-y-1 p-2"},Se={class:"input w-full"},Be={class:"overflow-y-auto h-full w-full"},Pe={class:"table table-compact table-pin-rows w-full"},Ue={class:"break-all"},ze={class:"text-nowrap"},$e={class:"text-nowrap"},Ce=V({__name:"LimitsTable",setup(x){const t=G.gpu_device.value,r=G.gpu_adapter.value,l=["maxBindGroups","maxBindGroupsPlusVertexBuffers","maxBindingsPerBindGroup","maxBufferSize","maxColorAttachmentBytesPerSample","maxColorAttachments","maxComputeInvocationsPerWorkgroup","maxComputeWorkgroupSizeX","maxComputeWorkgroupSizeY","maxComputeWorkgroupSizeZ","maxComputeWorkgroupStorageSize","maxComputeWorkgroupsPerDimension","maxDynamicStorageBuffersPerPipelineLayout","maxDynamicUniformBuffersPerPipelineLayout","maxInterStageShaderVariables","maxSampledTexturesPerShaderStage","maxSamplersPerShaderStage","maxStorageBufferBindingSize","maxStorageBuffersInFragmentStage","maxStorageBuffersInVertexStage","maxStorageBuffersPerShaderStage","maxStorageTexturesInFragmentStage","maxStorageTexturesInVertexStage","maxStorageTexturesPerShaderStage","maxTextureArrayLayers","maxTextureDimension1D","maxTextureDimension2D","maxTextureDimension3D","maxUniformBufferBindingSize","maxUniformBuffersPerShaderStage","maxVertexAttributes","maxVertexBufferArrayStride","maxVertexBuffers","minStorageBufferOffsetAlignment","minUniformBufferOffsetAlignment"],_=l.map(s=>({field:s,prepared:O.prepare(s)})),i=y(void 0);function u(s){if(s===void 0||s.length===0){i.value=void 0;return}const o=[];for(const{field:p,prepared:v}of _){const f=O.single(s,v);f!==null&&o.push({field:p,result:f})}i.value=o}const m=y(void 0),h=I(()=>i.value!==void 0?i.value.map(s=>s.field):l);return F(m,s=>{u(s)}),(s,o)=>(d(),c("div",ke,[e("label",Se,[q(w(N),{class:"size-[1.25rem]"}),P(e("input",{type:"search",placeholder:"Search","onUpdate:modelValue":o[0]||(o[0]=p=>m.value=p)},null,512),[[U,m.value]])]),e("div",Be,[e("table",Pe,[o[1]||(o[1]=e("thead",null,[e("tr",null,[e("th",{class:"w-full"},"Property"),e("th",null,"Adapter"),e("th",null,"Device")])],-1)),e("tbody",null,[(d(!0),c(D,null,R(h.value,p=>(d(),c("tr",{key:p},[e("td",Ue,S(p),1),e("td",ze,S(w(r).limits[p]??"N/A"),1),e("td",$e,S(w(t).limits[p]??"N/A"),1)]))),128))])])])]))}}),qe={class:"flex flex-col w-full h-full bg-base-100 gap-y-1 p-2"},Ge={class:"input w-full"},Te={class:"overflow-y-auto w-full h-full"},Ae={class:"table table-compact table-pin-rows w-full"},De={class:"text-center"},Ve=["checked"],Me={class:"text-center"},Oe=["checked"],We=V({__name:"FeaturesList",setup(x){const t=G.gpu_device.value,r=G.gpu_adapter.value,l=["bgra8unorm-storage","clip-distances","core-features-and-limits","depth-clip-control","depth32float-stencil8","dual-source-blending","float32-blendable","float32-filterable","indirect-first-instance","rg11b10ufloat-renderable","shader-f16","subgroups","texture-compression-astc","texture-compression-astc-sliced-3d","texture-compression-bc","texture-compression-bc-sliced-3d","texture-compression-etc2","timestamp-query"],_=l.map(s=>({feature:s,prepared:O.prepare(s)})),i=y(void 0);function u(s){if(s===void 0||s.length===0){i.value=void 0;return}const o=[];for(const{feature:p,prepared:v}of _){const f=O.single(s,v);f!==null&&o.push({feature:p,result:f})}i.value=o}const m=y(void 0),h=I(()=>i.value!==void 0?i.value.map(s=>s.feature):l);return F(m,s=>{u(s)}),(s,o)=>(d(),c("div",qe,[e("label",Ge,[q(w(N),{class:"size-[1.25rem]"}),P(e("input",{type:"search",placeholder:"Search","onUpdate:modelValue":o[0]||(o[0]=p=>m.value=p)},null,512),[[U,m.value]])]),e("div",Te,[e("table",Ae,[o[1]||(o[1]=e("thead",null,[e("tr",null,[e("th",{class:"w-full"},"Feature"),e("th",{class:"w-fit"},"Adapter"),e("th",{class:"w-fit"},"Device")])],-1)),e("tbody",null,[(d(!0),c(D,null,R(h.value,p=>(d(),c("tr",{key:p},[e("td",null,S(p),1),e("td",De,[e("input",{type:"checkbox",checked:w(r).features.has(p),disabled:""},null,8,Ve)]),e("td",Me,[e("input",{type:"checkbox",checked:w(t).features.has(p),disabled:""},null,8,Oe)])]))),128))])])])]))}}),Ee={class:"grid grid-cols-1 sm:grid-cols-2 gap-2"},Ye=V({__name:"BenchmarkView",setup(x){return(t,r)=>(d(),X(H,null,{"h-0":C(()=>r[0]||(r[0]=[A("Benchmarks")])),"b-0":C(()=>[e("div",Ee,[q(ce),q(we)])]),"h-1":C(()=>r[1]||(r[1]=[A("Limits")])),"b-1":C(()=>[q(Ce)]),"h-2":C(()=>r[2]||(r[2]=[A("Features")])),"b-2":C(()=>[q(We)]),_:1}))}});export{Ye as default};
