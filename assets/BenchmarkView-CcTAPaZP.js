var Q=Object.defineProperty;var j=(x,t,o)=>t in x?Q(x,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):x[t]=o;var b=(x,t,o)=>j(x,typeof t!="symbol"?t+"":t,o);import{d as A,j as y,b as d,o as c,f as e,u as w,w as P,m as U,F as T,r as W,t as S,y as R,a as L,l as I,g as q,k as K}from"./index-DFtOOGi2.js";import{S as X,p as C,w as O}from"./providers-DUnKue-j.js";import{f as V}from"./fuzzysort-EuvyY0K8.js";import{S as F}from"./search-BASbpgNg.js";class Z{constructor(t){b(this,"device");b(this,"compute_pipelines",new Map);b(this,"bind_group_layout");b(this,"pipeline_layout");b(this,"workgroup_size",256);b(this,"inner_loop_count",512);b(this,"iops_per_loop",4);b(this,"simd_width",4);b(this,"params",new X({loop_count:"s32",init_value:"f32"}));b(this,"params_uniform");this.device=t,this.params_uniform=t.createBuffer({size:this.params.buffer.byteLength,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),this.bind_group_layout=t.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.COMPUTE,buffer:{type:"uniform"}},{binding:1,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}}]}),this.pipeline_layout=t.createPipelineLayout({bindGroupLayouts:[this.bind_group_layout]})}get_type_size_bytes(t){switch(t){case"f16":return 2;case"f32":return 4;case"u32":return 4;case"i32":return 4}}get_inner_loop_code(t){switch(t){case"f16":case"f32":return`
          x = fma(y,x,y);
          y = fma(x,y,x);
        `;case"u32":case"i32":return`
          x = y*x + y;
          y = x*y + x;
        `}}get_benchmark_pipeline(t){let o=this.compute_pipelines.get(t);if(o===void 0){const l=`
        ${t==="f16"?"enable f16;":""}

        struct Params {
          loop_count: i32,
          init_value: f32,
        }

        @group(0) @binding(0) var<uniform> params: Params;
        @group(0) @binding(1) var<storage,read_write> A: array<vec4<${t}>>;

        override workgroup_size = 256;
        override inner_loop_count = 512;

        @compute
        @workgroup_size(workgroup_size,1,1)
        fn main(@builtin(global_invocation_id) _gid: vec3<u32>, @builtin(local_invocation_id) _lid: vec3<u32>) {
          let lid = _lid.x;

          var v = ${t}(params.init_value);
          var x = vec4<${t}>(v, v+1, v+2, v+3);
          var y = vec4<${t}>(${t}(lid));
          for (var iter = 0; iter < params.loop_count; iter++) {
            for (var inner = 0; inner < inner_loop_count; inner++) {
              ${this.get_inner_loop_code(t)}
            }
          }
          let gid = _gid.x;
          A[gid] = y;
        }
      `,_=this.device.createShaderModule({code:l}),i=this.device.createComputePipeline({layout:this.pipeline_layout,compute:{module:_,entryPoint:"main",constants:{workgroup_size:this.workgroup_size,inner_loop_count:this.inner_loop_count}}});o={shader_source:l,shader_module:_,compute_pipeline:i},this.compute_pipelines.set(t,o)}return o}get_init_value(t){switch(t){case"f16":return 1.3;case"f32":return 1.3;case"u32":return 4;case"i32":return-2}}create_pass(t,o,l,_,i){const u=Math.ceil(l/this.workgroup_size/this.simd_width);this.params.set("loop_count",i),this.params.set("init_value",this.get_init_value(_)),this.device.queue.writeBuffer(this.params_uniform,0,this.params.buffer,0,this.params.buffer.byteLength);const m=this.device.createBindGroup({layout:this.bind_group_layout,entries:[{binding:0,resource:{buffer:this.params_uniform,offset:0,size:this.params_uniform.size}},{binding:1,resource:{buffer:o,offset:0,size:o.size}}]}),v=this.get_benchmark_pipeline(_);t.setPipeline(v.compute_pipeline),t.setBindGroup(0,m),t.dispatchWorkgroups(u,1,1)}}class N{constructor(t,o){b(this,"device");b(this,"query_set");b(this,"query_buffer");b(this,"query_buffer_readback");b(this,"length");this.length=o,this.device=t,this.query_set=this.device.createQuerySet({type:"timestamp",count:2*o}),this.query_buffer=this.device.createBuffer({label:"query_resolve_buffer",size:8*this.query_set.count,usage:GPUBufferUsage.QUERY_RESOLVE|GPUBufferUsage.COPY_SRC}),this.query_buffer_readback=this.device.createBuffer({label:"query_resolve_buffer_map",size:this.query_buffer.size,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ})}get_timestamp_writes(t){if(t<0||t>=this.length)throw Error(`Timestamp index ${t} is out of bounds of length ${this.length}`);return{querySet:this.query_set,beginningOfPassWriteIndex:2*t,endOfPassWriteIndex:2*t+1}}enqueue_read(t){t.resolveQuerySet(this.query_set,0,2*this.length,this.query_buffer,0),t.copyBufferToBuffer(this.query_buffer,this.query_buffer_readback,this.query_buffer.size)}async read_timestamps(){const t=this.query_buffer_readback;await t.mapAsync(GPUMapMode.READ,0,t.size);const o=new BigUint64Array(t.getMappedRange(0,t.size).slice(0));t.unmap();const l=[];for(let _=0;_<this.length;_++){const i=o[2*_],u=o[2*_+1],m=u-i;l.push({start_ns:i,end_ns:u,elapsed_ns:m})}return l}destroy(){this.query_set.destroy(),this.query_buffer.destroy(),this.query_buffer_readback.destroy()}}const H={class:"card card-border bg-base-100"},J={class:"card-body p-3"},ee={class:"w-full"},te={key:0,class:"flex flex-col gap-x-1"},se={class:"table table-compact w-full"},re={class:"font-medium"},ae={key:0,class:"font-medium"},oe={key:1,class:"font-medium text-error"},ie=["value"],ne={colspan:"2"},ue=["disabled"],le={key:1,class:"w-full text-center py-2"},pe=A({__name:"ComputeBenchmarkView",setup(x){const t=C.gpu_device.value,o=t.features,l=new Z(t);function _(){const f=[];return f.push({type:"f16",base_outer_loops:4,iop_unit:"Flop/s",is_supported:o.has("shader-f16")},{type:"f32",base_outer_loops:2,iop_unit:"Flop/s",is_supported:!0},{type:"u32",base_outer_loops:1,iop_unit:"Iop/s",is_supported:!0},{type:"i32",base_outer_loops:1,iop_unit:"Iop/s",is_supported:!0}),f}const i=y(_()),u=y(12),m=y(4),v=y(8),s=y(2),r=y(!1);async function p(f,a,n,h){const k=l.get_type_size_bytes(f.type),M=t.createBuffer({size:n*k,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST|GPUBufferUsage.COPY_SRC}),B=new N(t,1);try{const $=[];for(let D=0;D<a;D++){const G=t.createCommandEncoder(),z=G.beginComputePass({timestampWrites:B.get_timestamp_writes(0)});l.create_pass(z,M,n,f.type,h),z.end(),B.enqueue_read(G),t.queue.submit([G.finish()]),await t.queue.onSubmittedWorkDone();const Y=(await B.read_timestamps())[0].elapsed_ns;$.push(Y),f.curr_step=D+1}return $}catch($){throw $}finally{M.destroy(),B.destroy()}}async function g(){if(r.value)return;const a=u.value*2048*l.workgroup_size,n=m.value+v.value;r.value=!0;for(const h of i.value)h.curr_step=0,h.total_steps=n,h.iop_rate=void 0,h.error=void 0;for(const h of i.value)if(h.is_supported)try{const k=h.base_outer_loops*s.value,B=(await p(h,n,a,k)).slice(m.value).map(z=>Number(z)*1e-9),$=B.reduce((z,E)=>z+E,0)/B.length,G=k*l.iops_per_loop*l.inner_loop_count*a/$;h.iop_rate=G}catch(k){h.error=String(k)}r.value=!1}return(f,a)=>(c(),d("div",H,[e("div",J,[a[10]||(a[10]=e("div",{class:"card-title"},"Compute Throughput",-1)),e("div",ee,[w(o).has("timestamp-query")?(c(),d("div",te,[e("table",se,[e("tbody",null,[e("tr",null,[a[5]||(a[5]=e("td",{class:"font-medium"},"Compute Units",-1)),e("td",null,[P(e("input",{class:"input",type:"number","onUpdate:modelValue":a[0]||(a[0]=n=>u.value=n),min:"1",step:"1"},null,512),[[U,u.value,void 0,{number:!0}]])])]),e("tr",null,[a[6]||(a[6]=e("td",{class:"font-medium"},"Work Multiplier",-1)),e("td",null,[P(e("input",{class:"input",type:"number","onUpdate:modelValue":a[1]||(a[1]=n=>s.value=n),min:"1",step:"1"},null,512),[[U,s.value,void 0,{number:!0}]])])]),e("tr",null,[a[7]||(a[7]=e("td",{class:"font-medium"},"Warmup Steps",-1)),e("td",null,[P(e("input",{class:"input",type:"number","onUpdate:modelValue":a[2]||(a[2]=n=>m.value=n),min:"1",step:"1"},null,512),[[U,m.value,void 0,{number:!0}]])])]),e("tr",null,[a[8]||(a[8]=e("td",{class:"font-medium"},"Warm Steps",-1)),e("td",null,[P(e("input",{class:"input",type:"number","onUpdate:modelValue":a[3]||(a[3]=n=>v.value=n),min:"1",step:"1"},null,512),[[U,v.value,void 0,{number:!0}]])])]),(c(!0),d(T,null,W(i.value,n=>(c(),d("tr",{key:n.type},[e("td",re,S(n.type),1),e("td",null,[n.is_supported?n.error?(c(),d("span",oe,S(n.error),1)):n.iop_rate===void 0?(c(),d("progress",{key:2,class:"w-full h-[1rem] progress progress-info",value:(n.curr_step??0)/(n.total_steps??1)*100,max:"100"},null,8,ie)):(c(),d(T,{key:3},[R(S(w(O)(n.iop_rate,n.iop_unit,3)),1)],64)):(c(),d("span",ae,"Not supported"))])]))),128)),e("tr",null,[e("td",ne,[e("button",{type:"submit",class:"btn w-full",onClick:a[4]||(a[4]=n=>g()),disabled:r.value},"Run benchmark",8,ue)])])])])])):(c(),d("div",le,a[9]||(a[9]=[e("h1",{class:"text-2xl"},"GPU profiling not supported",-1)])))])])]))}}),de={class:"card card-border bg-base-100"},ce={class:"card-body p-3"},_e={key:0,class:"flex flex-col gap-x-1"},me={class:"table table-compact"},fe={key:0,class:"font-medium text-error"},be=["value"],he={colspan:"2"},ve=["disabled"],ge={key:1,class:"w-full text-center py-2"},ye=A({__name:"MemoryBandwidthBenchmarkView",setup(x){const t=C.gpu_device.value,o=t.features,l=y(!1),_=y(30),i=t.limits.maxStorageBufferBindingSize,u=y({});async function m(){const v=t.createBuffer({size:i,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC}),s=t.createBuffer({size:i,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ}),r=new N(t,2);l.value=!0;const p=_.value;u.value.curr_step=0,u.value.total_steps=p,u.value.bandwidth=void 0,u.value.error=void 0;try{const g=t.createCommandEncoder();g.beginComputePass({timestampWrites:r.get_timestamp_writes(0)}).end();for(let k=0;k<p;k++)g.copyBufferToBuffer(v,s,i),await s.mapAsync(GPUMapMode.READ,0,i),u.value.curr_step=k+1,s.unmap();g.beginComputePass({timestampWrites:r.get_timestamp_writes(1)}).end(),r.enqueue_read(g),t.queue.submit([g.finish()]),await t.queue.onSubmittedWorkDone();const f=await r.read_timestamps(),a=f[1].start_ns-f[0].end_ns,n=Number(a)*1e-9,h=i*p/n;u.value.bandwidth=h}catch(g){u.value.error=String(g)}finally{l.value=!1,v.destroy(),s.destroy(),r.destroy()}}return(v,s)=>(c(),d("div",de,[e("div",ce,[s[6]||(s[6]=e("div",{class:"card-title"},"Memory Bandwidth",-1)),w(o).has("timestamp-query")?(c(),d("div",_e,[e("table",me,[e("tbody",null,[e("tr",null,[s[2]||(s[2]=e("td",{class:"font-medium"},"Total Transfers",-1)),e("td",null,[P(e("input",{class:"input",type:"number","onUpdate:modelValue":s[0]||(s[0]=r=>_.value=r),min:"1",step:"1"},null,512),[[U,_.value,void 0,{number:!0}]])])]),e("tr",null,[s[3]||(s[3]=e("td",{class:"font-medium"},"Buffer size",-1)),e("td",null,S(w(O)(w(i),"B",3)),1)]),e("tr",null,[s[4]||(s[4]=e("td",{class:"font-medium"},"Memory bandwidth",-1)),e("td",null,[u.value.error?(c(),d("span",fe,S(u.value.error),1)):u.value.bandwidth===void 0?(c(),d("progress",{key:1,class:"w-full h-[1rem] progress progress-info",value:(u.value.curr_step??0)/(u.value.total_steps??1)*100,max:"100"},null,8,be)):(c(),d(T,{key:2},[R(S(w(O)(u.value.bandwidth,"B/s",3)),1)],64))])]),e("tr",null,[e("td",he,[e("button",{type:"submit",class:"btn w-full",onClick:s[1]||(s[1]=r=>m()),disabled:l.value},"Run benchmark",8,ve)])])])])])):(c(),d("div",ge,s[5]||(s[5]=[e("h1",{class:"text-2xl"},"GPU profiling not supported",-1)])))])]))}}),xe={class:"card card-border bg-base-100"},we={class:"card-body p-3"},ke={class:"flex flex-col"},Se={class:"input w-full"},Be={class:"max-h-[65vh] sm:max-h-[75vh] overflow-y-auto w-full"},Pe={class:"table table-compact table-pin-rows w-full"},Ue={class:"break-all"},$e={class:"text-nowrap"},ze={class:"text-nowrap"},qe=A({__name:"LimitsTable",setup(x){const t=C.gpu_device.value,o=C.gpu_adapter.value,l=["maxBindGroups","maxBindGroupsPlusVertexBuffers","maxBindingsPerBindGroup","maxBufferSize","maxColorAttachmentBytesPerSample","maxColorAttachments","maxComputeInvocationsPerWorkgroup","maxComputeWorkgroupSizeX","maxComputeWorkgroupSizeY","maxComputeWorkgroupSizeZ","maxComputeWorkgroupStorageSize","maxComputeWorkgroupsPerDimension","maxDynamicStorageBuffersPerPipelineLayout","maxDynamicUniformBuffersPerPipelineLayout","maxInterStageShaderVariables","maxSampledTexturesPerShaderStage","maxSamplersPerShaderStage","maxStorageBufferBindingSize","maxStorageBuffersInFragmentStage","maxStorageBuffersInVertexStage","maxStorageBuffersPerShaderStage","maxStorageTexturesInFragmentStage","maxStorageTexturesInVertexStage","maxStorageTexturesPerShaderStage","maxTextureArrayLayers","maxTextureDimension1D","maxTextureDimension2D","maxTextureDimension3D","maxUniformBufferBindingSize","maxUniformBuffersPerShaderStage","maxVertexAttributes","maxVertexBufferArrayStride","maxVertexBuffers","minStorageBufferOffsetAlignment","minUniformBufferOffsetAlignment"],_=l.map(s=>({field:s,prepared:V.prepare(s)})),i=y(void 0);function u(s){if(s===void 0||s.length===0){i.value=void 0;return}const r=[];for(const{field:p,prepared:g}of _){const f=V.single(s,g);f!==null&&r.push({field:p,result:f})}i.value=r}const m=y(void 0),v=L(()=>i.value!==void 0?i.value.map(s=>s.field):l);return I(m,s=>{u(s)}),(s,r)=>(c(),d("div",xe,[e("div",we,[r[2]||(r[2]=e("div",{class:"card-title"},"GPU Limits",-1)),e("div",ke,[e("label",Se,[q(w(F),{class:"w-[1.25rem] h-[1.25rem]"}),P(e("input",{type:"search",placeholder:"Search","onUpdate:modelValue":r[0]||(r[0]=p=>m.value=p)},null,512),[[U,m.value]])]),e("div",Be,[e("table",Pe,[r[1]||(r[1]=e("thead",null,[e("tr",null,[e("th",{class:"w-full"},"Property"),e("th",null,"Adapter"),e("th",null,"Device")])],-1)),e("tbody",null,[(c(!0),d(T,null,W(v.value,p=>(c(),d("tr",{key:p},[e("td",Ue,S(p),1),e("td",$e,S(w(o).limits[p]??"N/A"),1),e("td",ze,S(w(t).limits[p]??"N/A"),1)]))),128))])])])])])]))}}),Ce={class:"card card-border bg-base-100"},Ge={class:"card-body p-3"},Te={class:"flex flex-col"},Ae={class:"input w-full"},De={class:"max-h-[65vh] sm:max-h-[75vh] overflow-y-auto w-full"},Ve={class:"table table-compact table-pin-rows w-full"},Me={class:"text-center"},Oe=["checked"],We={class:"text-center"},Ee=["checked"],Re=A({__name:"FeaturesList",setup(x){const t=C.gpu_device.value,o=C.gpu_adapter.value,l=["bgra8unorm-storage","clip-distances","core-features-and-limits","depth-clip-control","depth32float-stencil8","dual-source-blending","float32-blendable","float32-filterable","indirect-first-instance","rg11b10ufloat-renderable","shader-f16","subgroups","texture-compression-astc","texture-compression-astc-sliced-3d","texture-compression-bc","texture-compression-bc-sliced-3d","texture-compression-etc2","timestamp-query"],_=l.map(s=>({feature:s,prepared:V.prepare(s)})),i=y(void 0);function u(s){if(s===void 0||s.length===0){i.value=void 0;return}const r=[];for(const{feature:p,prepared:g}of _){const f=V.single(s,g);f!==null&&r.push({feature:p,result:f})}i.value=r}const m=y(void 0),v=L(()=>i.value!==void 0?i.value.map(s=>s.feature):l);return I(m,s=>{u(s)}),(s,r)=>(c(),d("div",Ce,[e("div",Ge,[r[2]||(r[2]=e("div",{class:"card-title"},"GPU Features",-1)),e("div",Te,[e("label",Ae,[q(w(F),{class:"w-[1.25rem] h-[1.25rem]"}),P(e("input",{type:"search",placeholder:"Search","onUpdate:modelValue":r[0]||(r[0]=p=>m.value=p)},null,512),[[U,m.value]])]),e("div",De,[e("table",Ve,[r[1]||(r[1]=e("thead",null,[e("tr",null,[e("th",{class:"w-full"},"Feature"),e("th",{class:"w-fit"},"Adapter"),e("th",{class:"w-fit"},"Device")])],-1)),e("tbody",null,[(c(!0),d(T,null,W(v.value,p=>(c(),d("tr",{key:p},[e("td",null,S(p),1),e("td",Me,[e("input",{type:"checkbox",checked:w(o).features.has(p),disabled:""},null,8,Oe)]),e("td",We,[e("input",{type:"checkbox",checked:w(t).features.has(p),disabled:""},null,8,Ee)])]))),128))])])])])])]))}}),Le={class:"tabs tabs-box w-full"},Ie=["name"],Fe={class:"tab-content overflow-auto p-1"},Ne={class:"grid grid-cols-1 sm:grid-cols-2 gap-2 w-full"},Ye=["name"],Qe={class:"tab-content overflow-auto p-1"},je=["name"],Ke={class:"tab-content overflow-auto p-1"},tt=A({__name:"BenchmarkView",setup(x){const t={tab:K()};return(o,l)=>(c(),d("div",Le,[e("input",{type:"radio",name:t.tab,class:"tab","aria-label":"Benchmarks",checked:""},null,8,Ie),e("div",Fe,[e("div",Ne,[q(pe),q(ye)])]),e("input",{type:"radio",name:t.tab,class:"tab","aria-label":"Limits"},null,8,Ye),e("div",Qe,[q(qe)]),e("input",{type:"radio",name:t.tab,class:"tab","aria-label":"Features"},null,8,je),e("div",Ke,[q(Re)])]))}});export{tt as default};
