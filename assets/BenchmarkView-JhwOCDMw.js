var H=Object.defineProperty;var J=(x,e,o)=>e in x?H(x,e,{enumerable:!0,configurable:!0,writable:!0,value:o}):x[e]=o;var g=(x,e,o)=>J(x,typeof e!="symbol"?e+"":e,o);import{d as M,s as U,j as k,b as p,o as i,g as t,u as v,f as $,r as V,t as y,w as E,e as I,q as R,n as F,h as P,m as D,a as Y,k as Q,C as ee,l as C}from"./index-a3sSa0D5.js";import{S as te,N as T,i as A,T as j,w as L,_ as se}from"./form_validation-DzRlF4F8.js";import{f as W}from"./fuzzysort-EuvyY0K8.js";import{S as K}from"./search-vctILLaD.js";class re{constructor(e){g(this,"device");g(this,"compute_pipelines",new Map);g(this,"bind_group_layout");g(this,"pipeline_layout");g(this,"workgroup_size",256);g(this,"inner_loop_count",512);g(this,"iops_per_loop",4);g(this,"simd_width",4);g(this,"params",new te({loop_count:"s32",init_value:"f32"}));g(this,"params_uniform");this.device=e,this.params_uniform=e.createBuffer({size:this.params.buffer.byteLength,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),this.bind_group_layout=e.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.COMPUTE,buffer:{type:"uniform"}},{binding:1,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}}]}),this.pipeline_layout=e.createPipelineLayout({bindGroupLayouts:[this.bind_group_layout]})}get_type_size_bytes(e){switch(e){case"f16":return 2;case"f32":return 4;case"u32":return 4;case"i32":return 4}}get_inner_loop_code(e){switch(e){case"f16":case"f32":return`
          x = fma(y,x,y);
          y = fma(x,y,x);
        `;case"u32":case"i32":return`
          x = y*x + y;
          y = x*y + x;
        `}}get_benchmark_pipeline(e){let o=this.compute_pipelines.get(e);if(o===void 0){const f=`
        ${e==="f16"?"enable f16;":""}

        struct Params {
          loop_count: i32,
          init_value: f32,
        }

        @group(0) @binding(0) var<uniform> params: Params;
        @group(0) @binding(1) var<storage,read_write> A: array<vec4<${e}>>;

        override workgroup_size = 256;
        override inner_loop_count = 512;

        @compute
        @workgroup_size(workgroup_size,1,1)
        fn main(@builtin(global_invocation_id) _gid: vec3<u32>, @builtin(local_invocation_id) _lid: vec3<u32>) {
          let lid = _lid.x;

          var v = ${e}(params.init_value);
          var x = vec4<${e}>(v, v+1, v+2, v+3);
          var y = vec4<${e}>(${e}(lid));
          for (var iter = 0; iter < params.loop_count; iter++) {
            for (var inner = 0; inner < inner_loop_count; inner++) {
              ${this.get_inner_loop_code(e)}
            }
          }
          let gid = _gid.x;
          A[gid] = y;
        }
      `,c=this.device.createShaderModule({code:f}),d=this.device.createComputePipeline({layout:this.pipeline_layout,compute:{module:c,entryPoint:"main",constants:{workgroup_size:this.workgroup_size,inner_loop_count:this.inner_loop_count}}});o={shader_source:f,shader_module:c,compute_pipeline:d},this.compute_pipelines.set(e,o)}return o}get_init_value(e){switch(e){case"f16":return 1.3;case"f32":return 1.3;case"u32":return 4;case"i32":return-2}}create_pass(e,o,f,c,d){const b=Math.ceil(f/this.workgroup_size/this.simd_width);this.params.set("loop_count",d),this.params.set("init_value",this.get_init_value(c)),this.device.queue.writeBuffer(this.params_uniform,0,this.params.buffer,0,this.params.buffer.byteLength);const _=this.device.createBindGroup({layout:this.bind_group_layout,entries:[{binding:0,resource:{buffer:this.params_uniform,offset:0,size:this.params_uniform.size}},{binding:1,resource:{buffer:o,offset:0,size:o.size}}]}),n=this.get_benchmark_pipeline(c);e.setPipeline(n.compute_pipeline),e.setBindGroup(0,_),e.dispatchWorkgroups(b,1,1)}}class X{constructor(e,o){g(this,"device");g(this,"query_set");g(this,"query_buffer");g(this,"query_buffer_readback");g(this,"length");this.length=o,this.device=e,this.query_set=this.device.createQuerySet({type:"timestamp",count:2*o}),this.query_buffer=this.device.createBuffer({label:"query_resolve_buffer",size:8*this.query_set.count,usage:GPUBufferUsage.QUERY_RESOLVE|GPUBufferUsage.COPY_SRC}),this.query_buffer_readback=this.device.createBuffer({label:"query_resolve_buffer_map",size:this.query_buffer.size,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ})}get_timestamp_writes(e){if(e<0||e>=this.length)throw Error(`Timestamp index ${e} is out of bounds of length ${this.length}`);return{querySet:this.query_set,beginningOfPassWriteIndex:2*e,endOfPassWriteIndex:2*e+1}}enqueue_read(e){e.resolveQuerySet(this.query_set,0,2*this.length,this.query_buffer,0),e.copyBufferToBuffer(this.query_buffer,this.query_buffer_readback,this.query_buffer.size)}async read_timestamps(){const e=this.query_buffer_readback;await e.mapAsync(GPUMapMode.READ,0,e.size);const o=new BigUint64Array(e.getMappedRange(0,e.size).slice(0));e.unmap();const f=[];for(let c=0;c<this.length;c++){const d=o[2*c],b=o[2*c+1],_=b-d;f.push({start_ns:d,end_ns:b,elapsed_ns:_})}return f}destroy(){this.query_set.destroy(),this.query_buffer.destroy(),this.query_buffer_readback.destroy()}}const oe={class:"card card-border bg-base-100"},ae={class:"card-body p-3"},ne={class:"w-full"},ie={key:0,class:"flex flex-col gap-x-1"},ue={class:"table table-compact w-full"},le={class:"font-medium text-nowrap"},pe=["onUpdate:modelValue","min","max","step"],ce={key:0,class:"text-error text-xs flex flex-row py-1 w-full"},_e={class:"font-medium"},de={key:0,class:"font-medium"},me={key:1,class:"font-medium text-error"},fe=["value"],he={colspan:"2"},ge=["disabled"],be={key:1,class:"w-full text-center py-2"},ve=M({__name:"ComputeBenchmarkView",setup(x){const e=U.gpu_device.value,o=U.user_data.value,f=e.features,c=new re(e);function d(){const a=[];return a.push({type:"f16",base_outer_loops:4,iop_unit:"Flop/s",is_supported:f.has("shader-f16")},{type:"f32",base_outer_loops:2,iop_unit:"Flop/s",is_supported:!0},{type:"u32",base_outer_loops:1,iop_unit:"Iop/s",is_supported:!0},{type:"i32",base_outer_loops:1,iop_unit:"Iop/s",is_supported:!0}),a}const b=k(d()),_=k(!1),n=o.compute_benchmark_config,u=k([new T(n,"total_compute_units","Compute Units",1,1024,1,A),new T(n,"work_multiplier","Work Multiplier",1,1024,1,A),new T(n,"total_warmup_steps","Warmup Steps",1,1024,1,A),new T(n,"total_warm_steps","Warmed Steps",1,1024,1,A)]);async function m(a,l,r,h){const B=c.get_type_size_bytes(a.type),q=e.createBuffer({size:r*B,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST|GPUBufferUsage.COPY_SRC}),S=new X(e,1);try{const w=[];for(let O=0;O<l;O++){const G=e.createCommandEncoder(),z=G.beginComputePass({timestampWrites:S.get_timestamp_writes(0)});c.create_pass(z,q,r,a.type,h),z.end(),S.enqueue_read(G),e.queue.submit([G.finish()]),await e.queue.onSubmittedWorkDone();const Z=(await S.read_timestamps())[0].elapsed_ns;w.push(Z),a.curr_step=O+1}return w}catch(w){throw w}finally{q.destroy(),S.destroy()}}async function s(){if(_.value)return;const l=n.total_compute_units*2048*c.workgroup_size,r=n.total_warmup_steps+n.total_warm_steps;_.value=!0;for(const h of b.value)h.curr_step=0,h.total_steps=r,h.iop_rate=void 0,h.error=void 0;for(const h of b.value)if(h.is_supported)try{const B=h.base_outer_loops*n.work_multiplier,S=(await m(h,r,l,B)).slice(n.total_warmup_steps).map(z=>Number(z)*1e-9),w=S.reduce((z,N)=>z+N,0)/S.length,G=B*c.iops_per_loop*c.inner_loop_count*l/w;h.iop_rate=G}catch(B){h.error=String(B)}_.value=!1}return(a,l)=>(i(),p("div",oe,[t("div",ae,[l[4]||(l[4]=t("div",{class:"card-title"},"Compute Throughput",-1)),t("div",ne,[v(f).has("timestamp-query")?(i(),p("div",ie,[t("table",ue,[l[1]||(l[1]=t("col",{class:"w-fit"},null,-1)),l[2]||(l[2]=t("col",{class:"w-full"},null,-1)),t("tbody",null,[(i(!0),p($,null,V(u.value,r=>(i(),p("tr",{key:r.key},[t("td",le,y(r.name),1),t("td",null,[E(t("input",{class:F(["input w-full",`${r.error?"input-error":""}`]),type:"number","onUpdate:modelValue":h=>r.value=h,min:r.min,max:r.max,step:r.step},null,10,pe),[[R,r.value,void 0,{number:!0}]]),r.error?(i(),p("div",ce,[P(v(j),{class:"size-[1rem] mr-1"}),t("span",null,y(r.error),1)])):I("",!0)])]))),128)),(i(!0),p($,null,V(b.value,r=>(i(),p("tr",{key:r.type},[t("td",_e,y(r.type),1),t("td",null,[r.is_supported?r.error?(i(),p("span",me,y(r.error),1)):r.iop_rate===void 0?(i(),p("progress",{key:2,class:"w-full h-[1rem] progress progress-info",value:(r.curr_step??0)/(r.total_steps??1)*100,max:"100"},null,8,fe)):(i(),p($,{key:3},[D(y(v(L)(r.iop_rate,r.iop_unit,3)),1)],64)):(i(),p("span",de,"Not supported"))])]))),128)),t("tr",null,[t("td",he,[t("button",{type:"submit",class:"btn w-full",onClick:l[0]||(l[0]=r=>s()),disabled:_.value},"Run benchmark",8,ge)])])])])])):(i(),p("div",be,l[3]||(l[3]=[t("h1",{class:"text-2xl"},"GPU profiling not supported",-1)])))])])]))}}),ye={class:"card card-border bg-base-100"},xe={class:"card-body p-3"},we={key:0,class:"flex flex-col gap-x-1"},ke={class:"table table-compact"},Se={class:"font-medium text-nowrap"},Be=["onUpdate:modelValue","min","max","step"],Pe={key:0,class:"text-error text-xs flex flex-row py-1 w-full"},Ue={key:0,class:"font-medium text-error"},$e=["value"],ze={colspan:"2"},Ce=["disabled"],qe={key:1,class:"w-full text-center py-2"},Ge=M({__name:"MemoryBandwidthBenchmarkView",setup(x){const e=U.gpu_device.value,o=U.user_data.value,f=e.features,c=k(!1),d=o.memory_bandwidth_benchmark_config,b=k([new T(d,"total_transfers","Total Transfers",1,1024,1,A)]),_=e.limits.maxStorageBufferBindingSize,n=k({});async function u(){const m=e.createBuffer({size:_,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC}),s=e.createBuffer({size:_,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ}),a=new X(e,2);c.value=!0;const l=d.total_transfers;n.value.curr_step=0,n.value.total_steps=l,n.value.bandwidth=void 0,n.value.error=void 0;try{const r=e.createCommandEncoder();r.beginComputePass({timestampWrites:a.get_timestamp_writes(0)}).end();for(let w=0;w<l;w++)r.copyBufferToBuffer(m,s,_),await s.mapAsync(GPUMapMode.READ,0,_),n.value.curr_step=w+1,s.unmap();r.beginComputePass({timestampWrites:a.get_timestamp_writes(1)}).end(),a.enqueue_read(r),e.queue.submit([r.finish()]),await e.queue.onSubmittedWorkDone();const h=await a.read_timestamps(),B=h[1].start_ns-h[0].end_ns,q=Number(B)*1e-9,S=_*l/q;n.value.bandwidth=S}catch(r){n.value.error=String(r)}finally{c.value=!1,m.destroy(),s.destroy(),a.destroy()}}return(m,s)=>(i(),p("div",ye,[t("div",xe,[s[6]||(s[6]=t("div",{class:"card-title"},"Memory Bandwidth",-1)),v(f).has("timestamp-query")?(i(),p("div",we,[t("table",ke,[s[3]||(s[3]=t("col",{class:"w-fit"},null,-1)),s[4]||(s[4]=t("col",{class:"w-full"},null,-1)),t("tbody",null,[(i(!0),p($,null,V(b.value,a=>(i(),p("tr",{key:a.key},[t("td",Se,y(a.name),1),t("td",null,[E(t("input",{class:F(["input w-full",`${a.error?"input-error":""}`]),type:"number","onUpdate:modelValue":l=>a.value=l,min:a.min,max:a.max,step:a.step},null,10,Be),[[R,a.value,void 0,{number:!0}]]),a.error?(i(),p("div",Pe,[P(v(j),{class:"size-[1rem] mr-1"}),t("span",null,y(a.error),1)])):I("",!0)])]))),128)),t("tr",null,[s[1]||(s[1]=t("td",{class:"font-medium text-nowrap"},"Buffer size",-1)),t("td",null,y(v(L)(v(_),"B",3)),1)]),t("tr",null,[s[2]||(s[2]=t("td",{class:"font-medium text-nowrap"},"Memory bandwidth",-1)),t("td",null,[n.value.error?(i(),p("span",Ue,y(n.value.error),1)):n.value.bandwidth===void 0?(i(),p("progress",{key:1,class:"w-full h-[1rem] progress progress-info",value:(n.value.curr_step??0)/(n.value.total_steps??1)*100,max:"100"},null,8,$e)):(i(),p($,{key:2},[D(y(v(L)(n.value.bandwidth,"B/s",3)),1)],64))])]),t("tr",null,[t("td",ze,[t("button",{type:"submit",class:"btn w-full",onClick:s[0]||(s[0]=a=>u()),disabled:c.value},"Run benchmark",8,Ce)])])])])])):(i(),p("div",qe,s[5]||(s[5]=[t("h1",{class:"text-2xl"},"GPU profiling not supported",-1)])))])]))}}),Te={class:"flex flex-col w-full h-full bg-base-100 gap-y-1 p-2"},Ae={class:"input w-full"},De={class:"overflow-y-auto h-full w-full"},Ve={class:"table table-compact table-pin-rows w-full"},Me={class:"break-all"},Oe={class:"text-nowrap"},We={class:"text-nowrap"},Ee=M({__name:"LimitsTable",setup(x){const e=U.gpu_device.value,o=U.gpu_adapter.value,f=["maxBindGroups","maxBindGroupsPlusVertexBuffers","maxBindingsPerBindGroup","maxBufferSize","maxColorAttachmentBytesPerSample","maxColorAttachments","maxComputeInvocationsPerWorkgroup","maxComputeWorkgroupSizeX","maxComputeWorkgroupSizeY","maxComputeWorkgroupSizeZ","maxComputeWorkgroupStorageSize","maxComputeWorkgroupsPerDimension","maxDynamicStorageBuffersPerPipelineLayout","maxDynamicUniformBuffersPerPipelineLayout","maxInterStageShaderVariables","maxSampledTexturesPerShaderStage","maxSamplersPerShaderStage","maxStorageBufferBindingSize","maxStorageBuffersInFragmentStage","maxStorageBuffersInVertexStage","maxStorageBuffersPerShaderStage","maxStorageTexturesInFragmentStage","maxStorageTexturesInVertexStage","maxStorageTexturesPerShaderStage","maxTextureArrayLayers","maxTextureDimension1D","maxTextureDimension2D","maxTextureDimension3D","maxUniformBufferBindingSize","maxUniformBuffersPerShaderStage","maxVertexAttributes","maxVertexBufferArrayStride","maxVertexBuffers","minStorageBufferOffsetAlignment","minUniformBufferOffsetAlignment"],c=f.map(u=>({field:u,prepared:W.prepare(u)})),d=k(void 0);function b(u){if(u===void 0||u.length===0){d.value=void 0;return}const m=[];for(const{field:s,prepared:a}of c){const l=W.single(u,a);l!==null&&m.push({field:s,result:l})}d.value=m}const _=k(void 0),n=Y(()=>d.value!==void 0?d.value.map(u=>u.field):f);return Q(_,u=>{b(u)}),(u,m)=>(i(),p("div",Te,[t("label",Ae,[P(v(K),{class:"size-[1.25rem]"}),E(t("input",{type:"search",placeholder:"Search","onUpdate:modelValue":m[0]||(m[0]=s=>_.value=s)},null,512),[[R,_.value]])]),t("div",De,[t("table",Ve,[m[1]||(m[1]=t("thead",null,[t("tr",null,[t("th",{class:"w-full"},"Property"),t("th",null,"Adapter"),t("th",null,"Device")])],-1)),t("tbody",null,[(i(!0),p($,null,V(n.value,s=>(i(),p("tr",{key:s},[t("td",Me,y(s),1),t("td",Oe,y(v(o).limits[s]??"N/A"),1),t("td",We,y(v(e).limits[s]??"N/A"),1)]))),128))])])])]))}}),Re={class:"flex flex-col w-full h-full bg-base-100 gap-y-1 p-2"},Le={class:"input w-full"},Ne={class:"overflow-y-auto w-full h-full"},Ie={class:"table table-compact table-pin-rows w-full"},Fe={class:"text-center"},Ye=["checked"],Qe={class:"text-center"},je=["checked"],Ke=M({__name:"FeaturesList",setup(x){const e=U.gpu_device.value,o=U.gpu_adapter.value,f=["bgra8unorm-storage","clip-distances","core-features-and-limits","depth-clip-control","depth32float-stencil8","dual-source-blending","float32-blendable","float32-filterable","indirect-first-instance","rg11b10ufloat-renderable","shader-f16","subgroups","texture-compression-astc","texture-compression-astc-sliced-3d","texture-compression-bc","texture-compression-bc-sliced-3d","texture-compression-etc2","timestamp-query"],c=f.map(u=>({feature:u,prepared:W.prepare(u)})),d=k(void 0);function b(u){if(u===void 0||u.length===0){d.value=void 0;return}const m=[];for(const{feature:s,prepared:a}of c){const l=W.single(u,a);l!==null&&m.push({feature:s,result:l})}d.value=m}const _=k(void 0),n=Y(()=>d.value!==void 0?d.value.map(u=>u.feature):f);return Q(_,u=>{b(u)}),(u,m)=>(i(),p("div",Re,[t("label",Le,[P(v(K),{class:"size-[1.25rem]"}),E(t("input",{type:"search",placeholder:"Search","onUpdate:modelValue":m[0]||(m[0]=s=>_.value=s)},null,512),[[R,_.value]])]),t("div",Ne,[t("table",Ie,[m[1]||(m[1]=t("thead",null,[t("tr",null,[t("th",{class:"w-full"},"Feature"),t("th",{class:"w-fit"},"Adapter"),t("th",{class:"w-fit"},"Device")])],-1)),t("tbody",null,[(i(!0),p($,null,V(n.value,s=>(i(),p("tr",{key:s},[t("td",null,y(s),1),t("td",Fe,[t("input",{type:"checkbox",checked:v(o).features.has(s),disabled:""},null,8,Ye)]),t("td",Qe,[t("input",{type:"checkbox",checked:v(e).features.has(s),disabled:""},null,8,je)])]))),128))])])])]))}}),Xe={class:"grid grid-cols-1 sm:grid-cols-2 gap-2"},st=M({__name:"BenchmarkView",setup(x){return(e,o)=>(i(),ee(se,null,{"h-0":C(()=>o[0]||(o[0]=[D("Benchmarks")])),"b-0":C(()=>[t("div",Xe,[P(ve),P(Ge)])]),"h-1":C(()=>o[1]||(o[1]=[D("Limits")])),"b-1":C(()=>[P(Ee)]),"h-2":C(()=>o[2]||(o[2]=[D("Features")])),"b-2":C(()=>[P(Ke)]),_:1}))}});export{st as default};
